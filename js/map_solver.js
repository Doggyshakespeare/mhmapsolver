function CSVToArray(e,t){t=",";for(var r=new RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),o=[[]],n=r.exec(e);n;){var a=n[1];a.length&&a!=t&&o.push([]);var p;p=n[2]?n[2].replace(new RegExp('""',"g"),'"'):n[3],o[o.length-1].push(p),n=r.exec(e)}return o}function processPop(){var e=pop.responseText;popCSV=CSVToArray(e);for(var t=Object.size(popCSV),r=1;t>r;r++){var o=popCSV[r],n=o[0],a=o[1],p=o[2],s=o[3],i=o[4];i=i.capitalise();var c=o[5];void 0===popArray[i]&&(popArray[i]=[]),void 0===popArray[i][n]&&(popArray[i][n]=[]),void 0===popArray[i][n][a]&&(popArray[i][n][a]=[]),void 0===popArray[i][n][a][p]&&(popArray[i][n][a][p]=[]),popArray[i][n][a][p][s]=c}loadMouseDropdown()}function loadMouseDropdown(){for(var e=Object.size(popArray),t=[],r=0;e>r;r++)t.push(Object.keys(popArray)[r]),t.push(Object.keys(popArray)[r].toLowerCase());$("#map").asuggest(t)}function amendMouseName(e){return e=e.capitalise().trim(),e.indexOf(" Mouse")>=0&&(e=e.slice(0,indexOfMouse)),e}function processMap(e){for(var t=e.split("\n").map(amendMouseName).filter(function(e){return e.length>0}).sort(),r="",o=[],n=[],a=0;a<t.length;a++){var p=t[a];if(void 0===popArray[p])n.push(p);else{var s=[];r+='<tr><td rowspan="2" class="mousename">'+p+"</td>";for(var i=Object.keys(popArray[p]),c=0;c<i.length;c++)for(var u=i[c],l=Object.keys(popArray[p][u]),h=0;h<l.length;h++)for(var d=l[h],m=Object.keys(popArray[p][u][d]),f=0;f<m.length;f++)for(var v=m[f],y=Object.keys(popArray[p][u][d][v]),b=0;b<y.length;b++){var g=y[b],A=u,O="best_setup.html?";O+="location="+u,"-"!=d&&(A+="<br>"+d),v.indexOf("/")<0&&(A+="<br>"+v),"-"!=g&&(A+="<br>"+g);var k=parseFloat(popArray[p][u][d][v][g]),w={name:p,rate:k};void 0===o[A]?o[A]={location:u,cheese:v.indexOf("/")<0?v:"",charm:"-"!=g?g:"",phase:"-"!=d?d:"",totalRate:k,mice:[w]}:(o[A].totalRate+=k,o[A].mice.push(w)),s[A]=k}for(var j=sortMouseLocations(s),x="<tr>",M=j.length>10?10:j.length,S=0;M>S;S++)r+="<td>"+j[S][0]+"</td>",x+="<td>"+j[S][1]+"</td>";j.length>10&&(r+='<td class="more">('+(j.length-10)+" more)</td>",x+="<td></td>"),r+="</tr>",x+="</tr>",r+=x}}n.length>0?($("#unknownmice").html(n.reduce(function(e,t){return e+t+"<br>"},"")),$("#unknownmicecontainer").show()):($("#unknownmice").html(""),$("#unknownmicecontainer").hide()),$("#mousecount").text(t.length-n.length+" mice"),$("#mouselist").html("<table>"+r+"</table>");var C=sortBestLocations(o);printBestLocations(C),r.length>0?($("#mouselistcontainer").show(),$("#bestlocationscontainer").show()):($("#mouselistcontainer").hide(),$("#bestlocationscontainer").hide())}function sortBestLocations(e){for(var t=[],r=Object.size(e),o=Object.keys(e),n=0;r>n;n++){var a=o[n];t.push(e[a])}return t.sort(function(e,t){return t.totalRate-e.totalRate}),t}function sortMouseLocations(e){for(var t=[],r=Object.size(e),o=Object.keys(e),n=0;r>n;n++){var a=o[n];t.push([a,e[a]])}return t.sort(function(e,t){return t[1]-e[1]}),t}function printBestLocations(e){var t="";t=e.reduce(function(e,t){return e+"<tr><td><b>"+t.location+"</b> ("+t.totalRate.toFixed(2)+")<br>"+(t.phase.length>0?t.phase+"<br>":"")+(t.cheese.length>0?t.cheese+"<br>":"")+(t.charm.length>0?t.charm+"<br>":"")+"</td><td>"+t.mice.sort(function(e,t){return t.rate-e.rate}).reduce(function(e,t){return e+t.name+" ("+t.rate.toFixed(2)+")<br>"},"")+"</tr>"},""),$("#bestlocations tbody").html(t)}var popCSV=[],popArray=[],pop=new XMLHttpRequest;pop.open("get","http://olf.github.io/mhmapsolver/data/populations.csv",!0),pop.onreadystatechange=function(){4==pop.readyState&&(processPop(),processMap($("#map").val()))},pop.send(),$(document).ready(function(){$("#map").val($.cookie("mouselist")),$("#map").keyup(function(){var e=$("#map").val();processMap(e),$.cookie("mouselist",e,{expires:14})})}),String.prototype.capitalise=function(){return this.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})},Object.size=function(e){var t=0;for(var r in e)e.hasOwnProperty(r)&&t++;return t};
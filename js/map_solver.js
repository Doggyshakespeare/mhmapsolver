function CSVToArray(e,t){t=",";for(var r=new RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),o=[[]],n=r.exec(e);n;){var a=n[1];a.length&&a!=t&&o.push([]);var s;s=n[2]?n[2].replace(new RegExp('""',"g"),'"'):n[3],o[o.length-1].push(s),n=r.exec(e)}return o}function processPop(){var e=pop.responseText;popCSV=CSVToArray(e);for(var t=Object.size(popCSV),r=1;t>r;r++){var o=popCSV[r],n=o[1],a="",s=o[3],p=o[4],i=o[0];i=i.capitalise();var c=o[8];void 0===popArray[i]&&(popArray[i]=[]),void 0===popArray[i][n]&&(popArray[i][n]=[]),void 0===popArray[i][n][a]&&(popArray[i][n][a]=[]),void 0===popArray[i][n][a][s]&&(popArray[i][n][a][s]=[]),popArray[i][n][a][s][p]=c}loadMouseDropdown()}function loadMouseDropdown(){for(var e=Object.size(popArray),t=[],r=0;e>r;r++)t.push(Object.keys(popArray)[r]),t.push(Object.keys(popArray)[r].toLowerCase());$("#map").asuggest(t)}function amendMouseName(e){return e=e.capitalise().trim(),e.indexOf(" Mouse")>=0&&(e=e.slice(0,indexOfMouse)),e}function processMap(e){var t=e.split("\n").map(amendMouseName).filter(function(e){return e.length>0}).sort();t=jQuery.unique(t);for(var r="",o=[],n=[],a=0;a<t.length;a++){var s=t[a];if(void 0===popArray[s])n.push(s);else{var p=[];r+='<tr><td rowspan="2" class="mousename">'+s+"</td>";for(var i=Object.keys(popArray[s]),c=0;c<i.length;c++)for(var u=i[c],l=Object.keys(popArray[s][u]),h=0;h<l.length;h++)for(var d=l[h],m=Object.keys(popArray[s][u][d]),v=0;v<m.length;v++)for(var f=m[v],y=Object.keys(popArray[s][u][d][f]),b=0;b<y.length;b++){var g=y[b],A=u;"-"!=d&&""!==d&&(A+="<br>"+d),f.length>0&&(A+="<br>"+f),"-"!=g&&(A+="<br>"+g);var O=parseFloat(popArray[s][u][d][f][g]),k={name:s,rate:O};void 0===o[A]?o[A]={location:u,cheese:f,charm:"-"!=g?g:"",phase:"-"!=d?d:"",totalRate:O,mice:[k]}:(o[A].totalRate+=O,o[A].mice.push(k)),p[A]=O}for(var w=sortMouseLocations(p),j="<tr>",x=w.length>10?10:w.length,M=0;x>M;M++)r+="<td>"+w[M][0]+"</td>",j+="<td>"+w[M][1].toFixed(2)+"%</td>";w.length>10&&(r+='<td class="more">('+(w.length-10)+" more)</td>",j+="<td></td>"),r+="</tr>",j+="</tr>",r+=j}}n.length>0?($("#unknownmice").html(n.reduce(function(e,t){return e+t+"<br>"},"")),$("#unknownmicecontainer").show()):($("#unknownmice").html(""),$("#unknownmicecontainer").hide()),$("#mousecount").text(t.length-n.length+" mice"),$("#mouselist").html("<table>"+r+"</table>");var S=sortBestLocations(o);printBestLocations(S),r.length>0?($("#mouselistcontainer").show(),$("#bestlocationscontainer").show()):($("#mouselistcontainer").hide(),$("#bestlocationscontainer").hide())}function sortBestLocations(e){for(var t=[],r=Object.size(e),o=Object.keys(e),n=0;r>n;n++){var a=o[n];t.push(e[a])}return t.sort(function(e,t){return t.totalRate-e.totalRate}),t}function sortMouseLocations(e){for(var t=[],r=Object.size(e),o=Object.keys(e),n=0;r>n;n++){var a=o[n];t.push([a,e[a]])}return t.sort(function(e,t){return t[1]-e[1]}),t}function printBestLocations(e){var t="";t=e.reduce(function(e,t){return e+"<tr><td><b>"+t.location+"</b> ("+t.totalRate.toFixed(2)+"%)<br>"+(t.phase.length>0?t.phase+"<br>":"")+(t.cheese.length>0?t.cheese+"<br>":"")+(t.charm.length>0?t.charm+"<br>":"")+"</td><td>"+t.mice.sort(function(e,t){return t.rate-e.rate}).reduce(function(e,t){return e+t.name+" ("+t.rate.toFixed(2)+"%)<br>"},"")+"</tr>"},""),$("#bestlocations tbody").html(t)}var popCSV=[],popArray=[],pop=new XMLHttpRequest;pop.open("get","http://olf.github.io/mhmapsolver/data/attractionrates.csv",!0),pop.onreadystatechange=function(){4==pop.readyState&&(processPop(),processMap($("#map").val()))},pop.send(),$(document).ready(function(){$("#map").val($.cookie("mouselist")),$("#map").keyup(function(){var e=$("#map").val();processMap(e),$.cookie("mouselist",e,{expires:14})})}),String.prototype.capitalise=function(){return this.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})},Object.size=function(e){var t=0;for(var r in e)e.hasOwnProperty(r)&&t++;return t};